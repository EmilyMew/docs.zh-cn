---
title: SQL Server 编程和宿主保护特性
ms.date: 03/30/2017
helpviewer_keywords:
- SQL Server [.NET Framework]
- permission sets, SQL Server
- SQL Server Programming and Host Protection Attributes
- managed code, SQL Server
- reliability [.NET Framework]
- writing reliable code
- hosts, reliability
- host protection attributes
- HostProtectionAttribute class, reliability
ms.assetid: 7dfa36b4-e773-4c75-a3ff-ff1af3ce4c4f
author: mairaw
ms.author: mairaw
ms.openlocfilehash: f1049187dabbea64599617bb4372ed50515a51e3
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/08/2019
ms.locfileid: "59088714"
---
# <a name="sql-server-programming-and-host-protection-attributes"></a>SQL Server 编程和宿主保护特性
在 SQL Server 主机中加载和执行托管代码需要满足主机对代码访问安全性和主机资源保护的要求。  代码访问安全性要求由三个 SQL Server 权限集之一指定：SAFE、 EXTERNAL-ACCESS 或 UNSAFE。 在 SAFE 或 EXTERNAL-ACCESS 权限集内执行的代码必须避免某些类型或应用了 <xref:System.Security.Permissions.HostProtectionAttribute> 属性的成员。 <xref:System.Security.Permissions.HostProtectionAttribute> 不是可靠性保证的安全权限，因为它标识主机可能禁止的特定代码结构（类型或方法）。  使用 <xref:System.Security.Permissions.HostProtectionAttribute> 可执行有助于保护主机稳定性的编程模型。  
  
## <a name="host-protection-attributes"></a>主机保护属性  
 主机保护属性识别不符合主机编程模型的类型或成员，并表示以下级别的可靠性威胁：  
  
-   为良性。  
  
-   可能导致服务器托管的用户代码不稳定。  
  
-   可能导致服务器进程本身不稳定。  
  
 SQL Server 不允许使用带有 <xref:System.Security.Permissions.HostProtectionAttribute> 的类型或成员，该属性指定 <xref:System.Security.Permissions.HostProtectionResource.SharedState>、<xref:System.Security.Permissions.HostProtectionResource.Synchronization>、<xref:System.Security.Permissions.HostProtectionResource.MayLeakOnAbort> 或 <xref:System.Security.Permissions.HostProtectionResource.ExternalProcessMgmt> 的 <xref:System.Security.Permissions.HostProtectionResource> 值。 这样可防止程序集调用启用共享状态、执行同步、终止时可能导致资源泄漏或影响 SQL Server 进程的完整性的成员。  
  
### <a name="disallowed-types-and-members"></a>不允许的类型和成员  
 下表标识了 SQL Server 禁止其 <xref:System.Security.Permissions.HostProtectionResource> 值的类型和成员。  
  
|命名空间|类型或成员|  
|---------------|--------------------|  
|`Microsoft.Win32`|<xref:Microsoft.Win32.PowerModeChangedEventArgs> class<br /><br /> <xref:Microsoft.Win32.PowerModeChangedEventHandler> 委托<br /><br /> <xref:Microsoft.Win32.SessionEndedEventArgs> class<br /><br /> <xref:Microsoft.Win32.SessionEndedEventHandler> 委托<br /><br /> <xref:Microsoft.Win32.SessionEndingEventArgs> class<br /><br /> <xref:Microsoft.Win32.SessionEndingEventHandler> 委托<br /><br /> <xref:Microsoft.Win32.SessionSwitchEventArgs> class<br /><br /> <xref:Microsoft.Win32.SessionSwitchEventHandler> 委托<br /><br /> <xref:Microsoft.Win32.SystemEvents> class<br /><br /> <xref:Microsoft.Win32.TimerElapsedEventArgs> class<br /><br /> <xref:Microsoft.Win32.TimerElapsedEventHandler> 委托<br /><br /> <xref:Microsoft.Win32.UserPreferenceChangedEventArgs> class<br /><br /> <xref:Microsoft.Win32.UserPreferenceChangingEventArgs> class|  
|`System.Collections`|<xref:System.Collections.ArrayList.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Hashtable.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Queue.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.SortedList.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Collections.Stack.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.ComponentModel`|<xref:System.ComponentModel.AddingNewEventArgs> class<br /><br /> <xref:System.ComponentModel.AddingNewEventHandler> 委托<br /><br /> <xref:System.ComponentModel.ArrayConverter> class<br /><br /> <xref:System.ComponentModel.AsyncCompletedEventArgs> class<br /><br /> <xref:System.ComponentModel.AsyncCompletedEventHandler> 委托<br /><br /> <xref:System.ComponentModel.AsyncOperation> class<br /><br /> <xref:System.ComponentModel.AsyncOperationManager> class<br /><br /> <xref:System.ComponentModel.AttributeCollection> class<br /><br /> <xref:System.ComponentModel.BackgroundWorker> class<br /><br /> <xref:System.ComponentModel.BaseNumberConverter> class<br /><br /> <xref:System.ComponentModel.BindingList%601> class<br /><br /> <xref:System.ComponentModel.BooleanConverter> class<br /><br /> <xref:System.ComponentModel.ByteConverter> class<br /><br /> <xref:System.ComponentModel.CancelEventArgs> class<br /><br /> <xref:System.ComponentModel.CancelEventHandler> 委托<br /><br /> <xref:System.ComponentModel.CharConverter> class<br /><br /> <xref:System.ComponentModel.CollectionChangeEventArgs> class<br /><br /> <xref:System.ComponentModel.CollectionChangeEventHandler> 委托<br /><br /> <xref:System.ComponentModel.CollectionConverter> class<br /><br /> <xref:System.ComponentModel.ComponentCollection> class<br /><br /> <xref:System.ComponentModel.ComponentConverter> class<br /><br /> <xref:System.ComponentModel.ComponentEditor> class<br /><br /> <xref:System.ComponentModel.ComponentResourceManager> class<br /><br /> <xref:System.ComponentModel.Container> class<br /><br /> <xref:System.ComponentModel.ContainerFilterService> class<br /><br /> <xref:System.ComponentModel.CultureInfoConverter> class<br /><br /> <xref:System.ComponentModel.CustomTypeDescriptor> class<br /><br /> <xref:System.ComponentModel.DateTimeConverter> class<br /><br /> <xref:System.ComponentModel.DecimalConverter> class<br /><br /> <xref:System.ComponentModel.Design.ActiveDesignerEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.ActiveDesignerEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.CheckoutException> class<br /><br /> <xref:System.ComponentModel.Design.CommandID> class<br /><br /> <xref:System.ComponentModel.Design.ComponentChangedEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.ComponentChangedEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.ComponentChangingEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.ComponentChangingEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.ComponentEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.ComponentEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.ComponentRenameEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.ComponentRenameEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.DesignerCollection> class<br /><br /> <xref:System.ComponentModel.Design.DesignerEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.DesignerEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.DesignerOptionService> class<br /><br /> <xref:System.ComponentModel.Design.DesignerTransaction> class<br /><br /> <xref:System.ComponentModel.Design.DesignerTransactionCloseEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.DesignerTransactionCloseEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.DesignerVerb> class<br /><br /> <xref:System.ComponentModel.Design.DesignerVerbCollection> class<br /><br /> <xref:System.ComponentModel.Design.DesigntimeLicenseContext> class<br /><br /> <xref:System.ComponentModel.Design.DesigntimeLicenseContextSerializer> class<br /><br /> <xref:System.ComponentModel.Design.MenuCommand> class<br /><br /> <xref:System.ComponentModel.Design.Serialization.ComponentSerializationService> class<br /><br /> <xref:System.ComponentModel.Design.Serialization.ContextStack> class<br /><br /> <xref:System.ComponentModel.Design.Serialization.DesignerLoader> class<br /><br /> <xref:System.ComponentModel.Design.Serialization.InstanceDescriptor> class<br /><br /> <xref:System.ComponentModel.Design.Serialization.MemberRelationshipService> class<br /><br /> <xref:System.ComponentModel.Design.Serialization.ResolveNameEventArgs> class<br /><br /> <xref:System.ComponentModel.Design.Serialization.ResolveNameEventHandler> 委托<br /><br /> <xref:System.ComponentModel.Design.Serialization.SerializationStore> class<br /><br /> <xref:System.ComponentModel.Design.ServiceContainer> class<br /><br /> <xref:System.ComponentModel.Design.ServiceCreatorCallback> 委托<br /><br /> <xref:System.ComponentModel.Design.StandardCommands> class<br /><br /> <xref:System.ComponentModel.Design.StandardToolWindows> class<br /><br /> <xref:System.ComponentModel.DoubleConverter> class<br /><br /> <xref:System.ComponentModel.DoWorkEventArgs> class<br /><br /> <xref:System.ComponentModel.DoWorkEventHandler> 委托<br /><br /> <xref:System.ComponentModel.EnumConverter> class<br /><br /> <xref:System.ComponentModel.EventDescriptor> class<br /><br /> <xref:System.ComponentModel.EventDescriptorCollection> class<br /><br /> <xref:System.ComponentModel.EventHandlerList> class<br /><br /> <xref:System.ComponentModel.ExpandableObjectConverter> class<br /><br /> <xref:System.ComponentModel.HandledEventArgs> class<br /><br /> <xref:System.ComponentModel.HandledEventHandler> 委托<br /><br /> <xref:System.ComponentModel.InstanceCreationEditor> class<br /><br /> <xref:System.ComponentModel.Int16Converter> class<br /><br /> <xref:System.ComponentModel.Int32Converter> class<br /><br /> <xref:System.ComponentModel.Int64Converter> class<br /><br /> <xref:System.ComponentModel.InvalidAsynchronousStateException> class<br /><br /> <xref:System.ComponentModel.InvalidEnumArgumentException> class<br /><br /> <xref:System.ComponentModel.ISynchronizeInvoke.BeginInvoke%2A> 方法<br /><br /> <xref:System.ComponentModel.License> class<br /><br /> <xref:System.ComponentModel.LicenseContext> class<br /><br /> <xref:System.ComponentModel.LicenseException> class<br /><br /> <xref:System.ComponentModel.LicenseManager> class<br /><br /> <xref:System.ComponentModel.LicenseProvider> class<br /><br /> <xref:System.ComponentModel.LicFileLicenseProvider> class<br /><br /> <xref:System.ComponentModel.ListChangedEventArgs> class<br /><br /> <xref:System.ComponentModel.ListChangedEventHandler> 委托<br /><br /> <xref:System.ComponentModel.ListSortDescription> class<br /><br /> <xref:System.ComponentModel.ListSortDescriptionCollection> class<br /><br /> <xref:System.ComponentModel.MaskedTextProvider> class<br /><br /> <xref:System.ComponentModel.MemberDescriptor> class<br /><br /> <xref:System.ComponentModel.MultilineStringConverter> class<br /><br /> <xref:System.ComponentModel.NestedContainer> class<br /><br /> <xref:System.ComponentModel.NullableConverter> class<br /><br /> <xref:System.ComponentModel.ProgressChangedEventArgs> class<br /><br /> <xref:System.ComponentModel.ProgressChangedEventHandler> 委托<br /><br /> <xref:System.ComponentModel.PropertyChangedEventArgs> class<br /><br /> <xref:System.ComponentModel.PropertyChangedEventHandler> 委托<br /><br /> <xref:System.ComponentModel.PropertyDescriptor> class<br /><br /> <xref:System.ComponentModel.PropertyDescriptorCollection> class<br /><br /> <xref:System.ComponentModel.ReferenceConverter> class<br /><br /> <xref:System.ComponentModel.RefreshEventArgs> class<br /><br /> <xref:System.ComponentModel.RefreshEventHandler> 委托<br /><br /> <xref:System.ComponentModel.RunWorkerCompletedEventArgs> class<br /><br /> <xref:System.ComponentModel.RunWorkerCompletedEventHandler> 委托<br /><br /> <xref:System.ComponentModel.SByteConverter> class<br /><br /> <xref:System.ComponentModel.SingleConverter> class<br /><br /> <xref:System.ComponentModel.StringConverter> class<br /><br /> <xref:System.ComponentModel.SyntaxCheck> class<br /><br /> <xref:System.ComponentModel.TimeSpanConverter> class<br /><br /> <xref:System.ComponentModel.TypeConverter> class<br /><br /> <xref:System.ComponentModel.TypeDescriptionProvider> class<br /><br /> <xref:System.ComponentModel.TypeDescriptor> class<br /><br /> <xref:System.ComponentModel.TypeListConverter> class<br /><br /> <xref:System.ComponentModel.UInt16Converter> class<br /><br /> <xref:System.ComponentModel.UInt32Converter> class<br /><br /> <xref:System.ComponentModel.UInt64Converter> class<br /><br /> <xref:System.ComponentModel.WarningException> class<br /><br /> <xref:System.ComponentModel.Win32Exception> class|  
|`System.Diagnostics`|<xref:System.Diagnostics.Debug.Listeners%2A?displayProperty=nameWithType> 属性<br /><br /> <xref:System.Diagnostics.Trace.Listeners%2A?displayProperty=nameWithType> 属性<br /><br /> <xref:System.Diagnostics.EventLog.SynchronizingObject%2A?displayProperty=nameWithType> 属性<br /><br /> <xref:System.Diagnostics.ConsoleTraceListener> class<br /><br /> <xref:System.Diagnostics.DefaultTraceListener> class<br /><br /> <xref:System.Diagnostics.DelimitedListTraceListener> class<br /><br /> <xref:System.Diagnostics.EventLogTraceListener> class<br /><br /> <xref:System.Diagnostics.PerformanceCounter> class<br /><br /> <xref:System.Diagnostics.PerformanceCounterCategory> class<br /><br /> <xref:System.Diagnostics.Process> class<br /><br /> <xref:System.Diagnostics.ProcessStartInfo> class<br /><br /> <xref:System.Diagnostics.TextWriterTraceListener> class<br /><br /> <xref:System.Diagnostics.TraceListener> class<br /><br /> <xref:System.Diagnostics.XmlWriterTraceListener> class<br /><br /> <xref:System.Diagnostics.TraceSource.Listeners%2A?displayProperty=nameWithType> 属性|  
|`System.IO`|<xref:System.IO.Stream.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.IO.TextReader.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.IO.TextWriter.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.Reflection.Emit`|<xref:System.Reflection.Emit.ConstructorBuilder> class<br /><br /> <xref:System.Reflection.Emit.EventBuilder> class<br /><br /> <xref:System.Reflection.Emit.FieldBuilder> class<br /><br /> <xref:System.Reflection.Emit.MethodBuilder> class<br /><br /> <xref:System.Reflection.Emit.CustomAttributeBuilder> class<br /><br /> <xref:System.Reflection.Emit.MethodRental> class<br /><br /> <xref:System.Reflection.Emit.ModuleBuilder> class<br /><br /> <xref:System.Reflection.Emit.PropertyBuilder> class<br /><br /> <xref:System.Reflection.Emit.TypeBuilder> class<br /><br /> <xref:System.Reflection.Emit.UnmanagedMarshal> class|  
|`System.Text`|<xref:System.Text.RegularExpressions.Group.Synchronized%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Text.RegularExpressions.Match.Synchronized%2A?displayProperty=nameWithType> 方法|  
|`System.Threading`|<xref:System.Threading.AutoResetEvent> class<br /><br /> <xref:System.Threading.EventWaitHandle> class<br /><br /> <xref:System.Threading.ManualResetEvent> class<br /><br /> <xref:System.Threading.Monitor> class<br /><br /> <xref:System.Threading.Mutex> class<br /><br /> <xref:System.Threading.ReaderWriterLock> class<br /><br /> <xref:System.Threading.Semaphore> class<br /><br /> <xref:System.Threading.Thread.AllocateNamedDataSlot%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.BeginCriticalRegion%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.EndCriticalRegion%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.FreeNamedDataSlot%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.GetData%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.Join%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SetApartmentState%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SetData%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.SpinWait%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.Start%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.Thread.TrySetApartmentState%2A?displayProperty=nameWithType> 方法<br /><br /> <xref:System.Threading.ThreadPool> class<br /><br /> <xref:System.Threading.Timer> class|  
|`System.Timers`|<xref:System.Timers.Timer> class|  
|`System.Web.Configuration`|<xref:System.Web.Configuration.MachineKeyValidationConverter> class|  
|`System.Windows.Forms`|<xref:System.Windows.Forms.AutoCompleteStringCollection.SyncRoot%2A?displayProperty=nameWithType> 属性|  
  
## <a name="sql-server-permission-sets"></a>SQL Server 权限集  
 SQL Server 能让用户指定部署到数据库的代码可靠性要求。 当程序集上传到数据库时，程序集的作者可以指定三个权限集之一该程序集：SAFE、 EXTERNAL-ACCESS 或 UNSAFE。  
  
|权限集|SAFE|EXTERNAL-ACCESS|UNSAFE|  
|--------------------|----------|----------------------|------------|  
|代码访问安全性|仅执行|执行+访问外部资源|不受限制|  
|编程模型限制|是|是|无限制|  
|可验证性要求|是|是|否|  
|调用本机代码的能力|否|否|是|  
  
 SAFE 是最可靠且安全的模式，在允许的编程模型方面具有相关限制。 SAFE 代码具有高可靠性和安全性功能。 SAFE 程序集有足够的权限来运行、执行计算，并有权访问本地数据库。 SAFE 程序集需要可验证类型安全，不允许调用非托管代码。  
  
 EXTERNAL-ACCESS 提供了一个中间安全选项，允许代码访问数据库外部的资源，但仍具有 SAFE 的可靠性和安全性。  
  
 UNSAFE 用于只能由数据库管理员创建的高度信任的代码。 这类信任代码没有代码访问限制，可以调用非托管（本机）代码。  
  
 SQL Server 使用主机级别代码访问安全策略层来设置主机策略，此策略根据 SQL Server 目录中存储的权限集授予三组权限之一。 在数据库内运行的托管代码始终能获得这些代码访问权限集之一。  
  
## <a name="programming-model-restrictions"></a>编程模型限制  
 SQL Server 中托管代码的编程模型需要无需使用跨多个调用的状态保留或跨多个用户会话共享状态的功能、过程和类型。 此外，如前所述，共享状态的存在可能导致关键异常，这些异常会影响应用程序的可扩展性和可靠性。  
  
 考虑到这些因素，SQL Server 不允许使用静态变量和静态数据成员。 对于 SAFE 和 EXTERNAL-ACCESS 程序集，SQL Server 将在 CREATE ASSEMBLY 时间检查程序集的元数据，如果发现使用静态数据成员和变量，则无法创建此类程序集。  
  
## <a name="see-also"></a>请参阅

- <xref:System.Security.Permissions.HostProtectionAttribute>
- <xref:System.Security.Permissions.HostProtectionResource>
